<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Generador de Rutina Personalizada</title>
<style>
    :root {
        --turq:#11c5c6;
        --turq-dark:#0ea7a8;
        --bg:#ffffff;
        --text:#1a1a1a;
        --card:#ffffff;
        --border:#d9d9d9;
        --subtext:#555;
        --radius-lg:20px;
        --radius-sm:10px;
    }
    [data-theme="dark"]{
        --bg:#0a0f10;
        --text:#f8f8f8;
        --card:#11181c;
        --border:#2d3a3f;
        --subtext:#9ba9ad;
        --turq:#11c5c6;
        --turq-dark:#0ea7a8;
    }

    *{
        box-sizing:border-box;
        -webkit-font-smoothing:antialiased;
        font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",sans-serif;
        margin:0;
        padding:0;
    }

    body{
        background:var(--bg);
        color:var(--text);
        display:flex;
        justify-content:center;
        padding:2rem 1rem 6rem;
    }

    .app{
        width:100%;
        max-width:900px;
        display:flex;
        flex-direction:column;
        gap:1.5rem;
        position:relative;
        padding-bottom:5rem; /* espacio para navbar fija */
    }

    header{
        text-align:center;
        position:relative;
    }

    .top-actions{
        position:absolute;
        top:-0.5rem;
        right:0;
        display:flex;
        gap:.5rem;
        flex-wrap:wrap;
        justify-content:flex-end;
    }

    .small-btn{
        background:var(--card);
        color:var(--text);
        border:1px solid var(--border);
        border-radius:999px;
        font-size:.7rem;
        font-weight:600;
        padding:.4rem .7rem;
        cursor:pointer;
    }

    .badge{
        display:inline-block;
        background:var(--turq);
        color:#fff;
        padding:.4rem .75rem;
        font-size:.8rem;
        font-weight:600;
        border-radius:999px;
        margin-bottom:.5rem;
    }

    h1{
        font-size:1.4rem;
        font-weight:700;
        line-height:1.2;
        color:var(--text);
        margin-bottom:.4rem;
    }

    .subtitle{
        font-size:.9rem;
        line-height:1.4;
        color:var(--subtext);
        max-width:480px;
        margin:0 auto;
    }

    /* cards */
    .card{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:var(--radius-lg);
        box-shadow:0 24px 40px -12px rgba(0,0,0,.4);
        padding:1rem 1rem 1.25rem;
    }

    .card h2{
        font-size:1rem;
        font-weight:600;
        color:var(--text);
        display:flex;
        align-items:flex-start;
        gap:.5rem;
        margin-bottom:1rem;
    }
    .card h2 span.icon{
        background:var(--turq);
        color:#fff;
        font-size:.8rem;
        line-height:1rem;
        min-width:1.6rem;
        height:1.6rem;
        border-radius:.5rem;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:700;
    }

    form{
        display:grid;
        gap:1rem;
    }

    .field{
        display:flex;
        flex-direction:column;
        gap:.4rem;
    }
    .field-row{
        display:flex;
        flex-wrap:wrap;
        gap:.75rem;
    }
    @media(min-width:600px){
        .field-row .field{
            flex:1;
        }
    }

    label{
        font-size:.8rem;
        font-weight:600;
        color:var(--text);
        display:flex;
        justify-content:space-between;
        flex-wrap:wrap;
        line-height:1.3;
    }
    label small{
        font-weight:400;
        color:var(--subtext);
        font-size:.7rem;
    }

    input, select, textarea{
        width:100%;
        background:var(--bg);
        border:1px solid var(--border);
        border-radius:var(--radius-sm);
        padding:.7rem .8rem;
        font-size:.9rem;
        color:var(--text);
        outline:none;
    }
    input:focus, select:focus, textarea:focus{
        border-color:var(--turq);
        box-shadow:0 0 0 3px rgb(17 197 198 / .2);
    }

    textarea{
        resize:none;
        min-height:60px;
    }

    /* bot√≥n principal */
    .btn-main{
        background:var(--turq);
        color:#fff;
        border:none;
        border-radius:var(--radius-sm);
        padding:.9rem 1rem;
        font-size:1rem;
        font-weight:600;
        cursor:pointer;
        text-align:center;
        box-shadow:0 16px 24px -8px rgba(17,197,198,.5);
        transition:all .15s;
        width:100%;
    }
    .btn-main:active{
        transform:scale(.98);
        background:var(--turq-dark);
    }

    /* Rutina resultado */
    .routine-card{
        background:var(--card);
        border:2px solid var(--turq);
        border-radius:var(--radius-lg);
        box-shadow:0 32px 56px -16px rgba(0,0,0,.5);
        padding:1rem;
    }

    .routine-header{
        display:flex;
        flex-direction:column;
        gap:.5rem;
        margin-bottom:1rem;
    }

    .routine-header-top{
        display:flex;
        flex-wrap:wrap;
        gap:.5rem;
        align-items:flex-start;
        justify-content:space-between;
    }

    .routine-title{
        font-size:1.1rem;
        font-weight:700;
        color:var(--text);
        display:flex;
        flex-direction:column;
        gap:.4rem;
    }

    .routine-meta{
        font-size:.75rem;
        line-height:1.3;
        color:var(--subtext);
        display:flex;
        flex-wrap:wrap;
        gap:.5rem;
    }
    .routine-chip{
        background:var(--turq);
        color:#fff;
        font-weight:600;
        border-radius:999px;
        padding:.3rem .6rem;
        font-size:.7rem;
        line-height:1;
        min-width:max-content;
        text-align:center;
    }

    .routine-cycle-label{
        font-size:.75rem;
        font-weight:600;
        background:#eefefe;
        color:#0a5c5c;
        border:1px solid #0ea7a833;
        border-radius:999px;
        padding:.3rem .6rem;
        line-height:1.2;
    }

    [data-theme="dark"] .routine-cycle-label{
        background:#0a3b3b;
        color:#cfffff;
    }

    .fatigue-label{
        font-size:.7rem;
        font-weight:600;
        border-radius:999px;
        padding:.3rem .6rem;
        line-height:1.2;
        border:1px solid var(--border);
    }

    .fatigue-green{ background:#d8ffd8; color:#003b00; }
    .fatigue-yellow{ background:#fff8cc; color:#4a3b00; }
    .fatigue-red{ background:#ffd8d8; color:#3b0000; }

    [data-theme="dark"] .fatigue-green{ background:#003b00; color:#d8ffd8; }
    [data-theme="dark"] .fatigue-yellow{ background:#4a3b00; color:#fff8cc; }
    [data-theme="dark"] .fatigue-red{ background:#3b0000; color:#ffd8d8; }

    .routine-block{
        border:1px solid var(--border);
        border-radius:var(--radius-sm);
        padding:.8rem;
        margin-bottom:1rem;
    }
    .routine-block h3{
        font-size:.9rem;
        font-weight:600;
        color:var(--text);
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        flex-wrap:wrap;
        margin-bottom:.6rem;
    }
    .routine-muscle{
        font-size:.7rem;
        font-weight:500;
        background:#eefefe;
        color:#0a5c5c;
        border:1px solid #0ea7a833;
        border-radius:999px;
        padding:.2rem .5rem;
        line-height:1.2;
    }
    [data-theme="dark"] .routine-muscle{
        background:#0a3b3b;
        color:#cfffff;
        border-color:#0ea7a888;
    }

    .exercise-list{
        display:grid;
        gap:.8rem;
    }

    .exercise-item{
        display:flex;
        gap:.8rem;
        align-items:flex-start;
        position:relative;
    }

    .exercise-done-checkbox{
        position:absolute;
        top:.4rem;
        right:.4rem;
        transform:scale(1.2);
    }

    .done .exercise-info{
        opacity:.4;
        text-decoration:line-through;
    }

    .exercise-img{
        width:80px;
        height:80px;
        min-width:80px;
        border-radius:var(--radius-sm);
        overflow:hidden;
        border:1px solid var(--border);
        background:#111;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:.7rem;
        font-weight:500;
        color:#666;
    }
    .exercise-img img{
        width:100%;
        height:100%;
        object-fit:cover;
    }

    .exercise-info{
        flex:1;
        display:flex;
        flex-direction:column;
        gap:.25rem;
        color:var(--text);
    }

    .exercise-name{
        font-size:.9rem;
        font-weight:600;
        color:var(--text);
        line-height:1.2;
        display:flex;
        flex-wrap:wrap;
        gap:.4rem;
        align-items:center;
    }
    .exercise-sets{
        font-size:.8rem;
        color:var(--text);
    }
    .exercise-extra{
        font-size:.7rem;
        color:var(--subtext);
        line-height:1.3;
    }
    .exercise-link a{
        font-size:.7rem;
        color:var(--turq);
        text-decoration:none;
    }

    .note-box{
        background:#f8ffff;
        border:1px solid #0ea7a822;
        border-radius:var(--radius-sm);
        padding:.7rem .8rem;
        font-size:.75rem;
        color:#044;
        line-height:1.4;
        margin-top:.5rem;
    }

    [data-theme="dark"] .note-box{
        background:#0a3b3b;
        color:#cfffff;
        border-color:#0ea7a866;
    }

    .warning-box{
        background:#fff8cc;
        border:1px solid #c7a400;
        color:#4a3b00;
    }

    [data-theme="dark"] .warning-box{
        background:#4a3b00;
        border-color:#c7a400;
        color:#fff8cc;
    }

    /* historial */
    .history-card{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:var(--radius-lg);
        padding:1rem;
        box-shadow:0 24px 40px -12px rgba(0,0,0,.4);
        font-size:.8rem;
        color:var(--text);
    }
    .history-card h3{
        font-size:.9rem;
        font-weight:600;
        margin-bottom:.5rem;
        color:var(--text);
        display:flex;
        align-items:center;
        gap:.4rem;
    }
    .history-list{
        max-height:150px;
        overflow:auto;
        font-size:.75rem;
        line-height:1.4;
        color:var(--subtext);
    }
    .history-item{
        border-bottom:1px solid var(--border);
        padding:.4rem 0;
    }

    footer{
        text-align:center;
        font-size:.7rem;
        color:var(--subtext);
        padding-bottom:3rem;
    }

    /* navbar inferior tipo app */
    .bottom-nav{
        position:fixed;
        left:0;
        right:0;
        bottom:0;
        background:var(--card);
        border-top:1px solid var(--border);
        box-shadow:0 -16px 32px -8px rgba(0,0,0,.6);
        display:flex;
        justify-content:space-around;
        padding:.6rem .5rem .8rem;
        z-index:999;
    }
    .nav-btn{
        flex:1;
        border:none;
        background:none;
        color:var(--text);
        font-size:.7rem;
        font-weight:600;
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:.25rem;
        cursor:pointer;
    }
    .nav-btn span.icon{
        font-size:1rem;
        line-height:1;
    }

    @media(min-width:768px){
        body{
            padding:3rem 1rem 6rem;
        }
        h1{
            font-size:1.8rem;
        }
        .subtitle{
            font-size:1rem;
        }
        .card{
            padding:1.25rem 1.25rem 1.5rem;
        }
        .routine-card{
            padding:1.25rem 1.25rem 1.5rem;
        }
    }

    /* impresi√≥n: solo rutina */
    @media print {
        body{
            background:#fff;
            color:#000;
            padding:0;
        }
        .card,
        header,
        footer,
        .bottom-nav,
        .history-card{
            display:none !important;
        }
        .routine-card{
            border:1px solid #000 !important;
            box-shadow:none !important;
        }
    }
</style>
</head>
<body>
<div class="app">

    <header>
        <div class="top-actions">
            <button class="small-btn" id="themeToggle">üåô Oscuro</button>
            <button class="small-btn" id="printBtn">üñ® PDF</button>
        </div>

        <div class="badge">Rutina personalizada</div>
        <h1>Plan de Entrenamiento Casa / Gimnasio</h1>
        <p class="subtitle">
            Rellena tu perfil una vez (se guarda). Te doy D√≠a A / B / C con progresi√≥n,
            descanso activo y alertas de sobrecarga. Marca cada ejercicio como ‚úÖ Hecho.
        </p>
    </header>

    <!-- FORM PERFIL -->
    <section class="card" id="perfilCard">
        <h2><span class="icon">1</span>Datos personales b√°sicos üßç‚Äç‚ôÇÔ∏è</h2>
        <form id="fitnessForm">
            <div class="field-row">
                <div class="field">
                    <label>G√©nero</label>
                    <select id="genero" required>
                        <option value="">Elige...</option>
                        <option value="femenino">Femenino</option>
                        <option value="masculino">Masculino</option>
                        <option value="otro">Otro / Prefiero no decir</option>
                    </select>
                </div>
                <div class="field">
                    <label>Edad (a√±os)</label>
                    <input type="number" id="edad" min="10" max="100" placeholder="20, 30, 40..." required />
                </div>
            </div>

            <div class="field-row">
                <div class="field">
                    <label>Peso (kg)</label>
                    <input type="number" id="peso" min="20" max="300" placeholder="Ej: 72" required />
                </div>
                <div class="field">
                    <label>Altura (cm)</label>
                    <input type="number" id="altura" min="120" max="230" placeholder="Ej: 175" required />
                </div>
            </div>

            <div class="field">
                <label>Objetivo principal <small>(elige el m√°s importante)</small></label>
                <select id="objetivo" required>
                    <option value="">Elige...</option>
                    <option value="bajar grasa">Bajar de peso / grasa</option>
                    <option value="musculo">Ganar masa muscular</option>
                    <option value="tonificar">Tonificar / marcar</option>
                    <option value="resistencia">Mejorar resistencia</option>
                    <option value="salud">Moverme y estar m√°s saludable</option>
                </select>
            </div>

            <hr style="border:none;border-top:1px solid var(--border);" />

            <h2><span class="icon">2</span>Estado f√≠sico y salud ‚ù§Ô∏è</h2>

            <div class="field">
                <label>Lesiones o limitaciones f√≠sicas</label>
                <textarea id="lesiones" placeholder="Rodilla izquierda, lumbar, hombro derecho... o 'ninguna'"></textarea>
            </div>

            <div class="field">
                <label>Condici√≥n m√©dica a considerar</label>
                <textarea id="condicion" placeholder="Hipertensi√≥n, asma, etc... o 'ninguna'"></textarea>
            </div>

            <div class="field-row">
                <div class="field">
                    <label>¬øHace cu√°nto no entrenas?</label>
                    <select id="tiempoSinEntrenar">
                        <option value="0-3 meses">0-3 meses</option>
                        <option value="3-12 meses">3-12 meses</option>
                        <option value="1-3 a√±os">1-3 a√±os</option>
                        <option value="m√°s de 3 a√±os">M√°s de 3 a√±os</option>
                    </select>
                </div>
                <div class="field">
                    <label>Nivel f√≠sico actual</label>
                    <select id="nivel" required>
                        <option value="">Elige...</option>
                        <option value="bajo">Bajo</option>
                        <option value="medio">Medio</option>
                        <option value="alto">Alto</option>
                    </select>
                </div>
            </div>

            <hr style="border:none;border-top:1px solid var(--border);" />

            <h2><span class="icon">3</span>Disponibilidad y entorno üïì</h2>

            <div class="field-row">
                <div class="field">
                    <label>D√≠as por semana</label>
                    <select id="dias" required>
                        <option value="">Elige...</option>
                        <option value="2">2 d√≠as</option>
                        <option value="3">3 d√≠as</option>
                        <option value="4">4 d√≠as</option>
                        <option value="5">5 d√≠as</option>
                        <option value="6">6 d√≠as</option>
                        <option value="7">7 d√≠as</option>
                    </select>
                </div>
                <div class="field">
                    <label>Duraci√≥n por sesi√≥n</label>
                    <select id="duracion" required>
                        <option value="">Elige...</option>
                        <option value="20 min">20 min</option>
                        <option value="30 min">30 min</option>
                        <option value="45 min">45 min</option>
                        <option value="1 hora">1 hora</option>
                        <option value="+1 hora">M√°s de 1 hora</option>
                    </select>
                </div>
            </div>

            <div class="field-row">
                <div class="field">
                    <label>Horario favorito</label>
                    <select id="horario" required>
                        <option value="">Elige...</option>
                        <option value="ma√±ana">Ma√±ana</option>
                        <option value="tarde">Tarde</option>
                        <option value="noche">Noche</option>
                    </select>
                </div>
                <div class="field">
                    <label>¬øD√≥nde vas a entrenar?</label>
                    <select id="lugar" required>
                        <option value="">Elige...</option>
                        <option value="casa">Casa</option>
                        <option value="gimnasio">Gimnasio</option>
                        <option value="mixto">A veces casa / a veces gym</option>
                    </select>
                </div>
            </div>

            <div class="field">
                <label>Espacio en casa</label>
                <select id="espacio">
                    <option value="peque√±o">Peque√±o (1-2 m¬≤, apenas colchoneta)</option>
                    <option value="normal">Normal (2x2 m puedo moverme)</option>
                    <option value="amplio">Amplio (puedo saltar / desplazarme)</option>
                </select>
            </div>

            <div class="field">
                <label>Equipo disponible</label>
                <textarea id="equipo" placeholder="Mancuernas 5kg, banda el√°stica, colchoneta... o 'solo peso corporal'"></textarea>
            </div>

            <hr style="border:none;border-top:1px solid var(--border);" />

            <h2><span class="icon">4</span>Preferencias y motivaci√≥n ‚öôÔ∏è</h2>

            <div class="field">
                <label>Tipo de ejercicios que prefieres</label>
                <select id="preferencia">
                    <option value="fuerza">Fuerza / pesas</option>
                    <option value="cardio">Cardio / quema calor√≠as</option>
                    <option value="hiit">HIIT (r√°pido e intenso)</option>
                    <option value="movilidad">Movilidad / postura / espalda sana</option>
                    <option value="mix">Un poco de todo</option>
                </select>
            </div>

            <div class="field-row">
                <div class="field">
                    <label>Experiencia previa entrenando</label>
                    <select id="experiencia">
                        <option value="nuevo">Nunca he seguido una rutina</option>
                        <option value="basico">Algo b√°sico en casa o gym</option>
                        <option value="intermedio">Entren√© varios meses antes</option>
                        <option value="avanzado">A√±os entrenando serio</option>
                    </select>
                </div>
                <div class="field">
                    <label>Motivaci√≥n actual (1-10)</label>
                    <input type="number" id="motivacion" min="1" max="10" value="7" />
                </div>
            </div>

            <div class="field-row">
                <div class="field">
                    <label>Estilo de rutina</label>
                    <select id="intensidad">
                        <option value="suave">Suave y progresiva</option>
                        <option value="balanceada">Balanceada</option>
                        <option value="explosiva">Intensa y corta</option>
                    </select>
                </div>
                <div class="field">
                    <label>¬øQuieres acompa√±amiento musical / app?</label>
                    <select id="acompanamiento">
                        <option value="musica">Con m√∫sica motivante</option>
                        <option value="silencio">Prefiero silencio / foco</option>
                        <option value="app">Con gu√≠a tipo app / temporizador HIIT</option>
                    </select>
                </div>
            </div>

            <div class="field-row">
                <div class="field">
                    <label>¬øC√≥mo te sientes HOY? (fatiga)</label>
                    <select id="fatiga">
                        <option value="verde">üíö Normal / fresco</option>
                        <option value="amarillo">üü° Cansado</option>
                        <option value="rojo">üî¥ Muy cargado</option>
                    </select>
                </div>
                <div class="field">
                    <label>Sugerencia de peso (opcional)
                        <small>ej: "Sentadilla ~40kg", "Press banca ~20kg"</small>
                    </label>
                    <input id="fuerzaBase" placeholder="Peso que ya manejas c√≥modo" />
                </div>
            </div>

            <hr style="border:none;border-top:1px solid var(--border);" />

            <h2><span class="icon">5</span>Seguimiento y metas üìà</h2>

            <div class="field">
                <label>Plazo/meta temporal</label>
                <select id="plazo">
                    <option value="1 mes">Quiero arrancar el h√°bito (1 mes)</option>
                    <option value="3 meses">Notar cambios f√≠sicos (3 meses)</option>
                    <option value="6 meses">Cambio m√°s notorio (6 meses)</option>
                    <option value="largo plazo">Mantener salud / largo plazo</option>
                </select>
            </div>

            <div class="field-row">
                <div class="field">
                    <label>¬øRegistrar avances?</label>
                    <select id="seguimiento">
                        <option value="si">S√≠, peso / medidas / energ√≠a</option>
                        <option value="progreso-fotos">Solo fotos de progreso</option>
                        <option value="rendimiento">Solo rendimiento (m√°s repeticiones)</option>
                        <option value="no">No quiero seguimiento</option>
                    </select>
                </div>
                <div class="field">
                    <label>Motivaci√≥n especial</label>
                    <input id="motivacionEspecial" placeholder="Postura, verano, estr√©s, autoestima, etc." />
                </div>
            </div>

            <button type="button" class="btn-main" id="generarBtn">GENERAR MI RUTINA üî•</button>
        </form>
    </section>

    <!-- RUTINA RESULTADO -->
    <section id="routineSection" class="routine-card" style="display:none;">
        <div class="routine-header">
            <div class="routine-header-top">
                <div class="routine-title">
                    <div id="cycleLabel" class="routine-cycle-label">D√≠a A ¬∑ Pierna fuerte + Core</div>
                    <div class="routine-meta" id="routineMeta"></div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.4rem;min-width:max-content;">
                    <div class="routine-chip" id="chipLugar">CASA</div>
                    <div id="fatigaView" class="fatigue-label fatigue-green">Estado: üíö Fresco</div>
                </div>
            </div>

            <div class="note-box" id="alertaLesion" style="display:none;">
                ‚ö† Cuidado especial por tu lesi√≥n/condici√≥n. Evita dolor agudo, prioriza t√©cnica lenta.
            </div>
            <div class="note-box warning-box" id="sobrecargaWarning" style="display:none;">
                Recomendaci√≥n de recuperaci√≥n activa: vienes repitiendo pierna pesada muy seguido. Hoy baja la intensidad y enf√≥cate en movilidad / core.
            </div>
            <div class="note-box" id="warmupBox" style="display:none;"></div>
        </div>

        <div id="routineBlocks">
            <!-- bloques de ejercicios se rellenan con JS -->
        </div>

        <div class="note-box" id="extraNotas">
            Respira entre series (60-90s fuerza / 30-45s cardio). Calienta 5 min (cuello,
            hombros, cadera, rodillas). Termina con estiramientos suaves y respiraci√≥n profunda.
        </div>
    </section>

    <!-- HISTORIAL -->
    <section id="historySection" class="history-card" style="display:none;">
        <h3>üïí Historial de sesiones</h3>
        <div class="history-list" id="historyList"></div>
    </section>

    <footer>
        Guardado local. No sube nada a internet. üíô
    </footer>

</div>

<!-- navbar inferior tipo app -->
<nav class="bottom-nav">
    <button class="nav-btn" id="navShowRoutine">
        <span class="icon">üìã</span>
        <span>Rutina hoy</span>
    </button>
    <button class="nav-btn" id="navGenerateNext">
        <span class="icon">üîÅ</span>
        <span>Cambiar d√≠a</span>
    </button>
    <button class="nav-btn" id="navShowProfile">
        <span class="icon">‚öô</span>
        <span>Perfil</span>
    </button>
    <button class="nav-btn" id="navShowHistory">
        <span class="icon">üìú</span>
        <span>Historial</span>
    </button>
</nav>

<script>
/* ==============================
   UTILIDAD LOCALSTORAGE
================================= */
const STORAGE_KEY_PROFILE = "rutinaPerfilV1";
const STORAGE_KEY_ROUTINE_INDEX = "rutinaIndexV1";
const STORAGE_KEY_WEEK_LEVEL = "rutinaWeekLevelV1"; // progresi√≥n semanal
const STORAGE_KEY_HISTORY = "rutinaHistoryV1";

function loadProfile(){
    try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY_PROFILE)) || null;
    }catch(e){return null;}
}
function saveProfile(data){
    localStorage.setItem(STORAGE_KEY_PROFILE, JSON.stringify(data));
}
function loadRoutineIndex(){
    let idx = parseInt(localStorage.getItem(STORAGE_KEY_ROUTINE_INDEX),10);
    if(isNaN(idx)){idx=0;}
    return idx;
}
function saveRoutineIndex(idx){
    localStorage.setItem(STORAGE_KEY_ROUTINE_INDEX, String(idx));
}
function loadWeekLevel(){
    let lvl = parseInt(localStorage.getItem(STORAGE_KEY_WEEK_LEVEL),10);
    if(isNaN(lvl)){lvl=1;} // semana 1 por defecto
    return lvl;
}
function saveWeekLevel(lvl){
    localStorage.setItem(STORAGE_KEY_WEEK_LEVEL, String(lvl));
}
function loadHistory(){
    try{
        return JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || [];
    }catch(e){return [];}
}
function saveHistory(arr){
    localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(arr));
}

/* ==============================
   BASE DE EJERCICIOS
   foco nos ayuda a armar bloques
================================= */
const EXERCISES = [
    {
        nombre:"Sentadilla libre",
        musculo:"Piernas / Gl√∫teos",
        tipo:"piernas",
        foco:"piernas_gluteos",
        lugar:"casa",
        tips:"Espalda recta, rodillas alineadas con pies. Baja controlado.",
        yt:"sentadilla correcta principiantes"
    },
    {
        nombre:"Peso muerto con mancuernas",
        musculo:"Isquios / Gl√∫teos",
        tipo:"piernas",
        foco:"posterior_cadena",
        lugar:"gimnasio",
        tips:"Empuja caderas atr√°s, no redondees la espalda.",
        yt:"peso muerto mancuernas tecnica espalda recta"
    },
    {
        nombre:"Zancadas alternadas",
        musculo:"Piernas / Estabilidad",
        tipo:"piernas",
        foco:"piernas_estabilidad",
        lugar:"casa",
        tips:"Paso largo, rodilla trasera cerca del suelo.",
        yt:"zancadas lunges tecnica"
    },
    {
        nombre:"Flexiones de pecho",
        musculo:"Pecho / Tr√≠ceps / Hombro frontal",
        tipo:"pecho",
        foco:"empuje_pecho_triceps",
        lugar:"casa",
        tips:"Manos debajo del pecho, cuerpo en l√≠nea recta. Rodillas al suelo si es dif√≠cil.",
        yt:"flexiones de pecho principiantes tecnica"
    },
    {
        nombre:"Press banca con mancuernas",
        musculo:"Pecho / Tr√≠ceps",
        tipo:"pecho",
        foco:"hipertrofia_pecho",
        lugar:"gimnasio",
        tips:"Controla la bajada, no rebotes con el pecho.",
        yt:"press banca mancuernas tecnica"
    },
    {
        nombre:"Remo inclinado con mancuerna/banda",
        musculo:"Espalda alta / B√≠ceps",
        tipo:"espalda",
        foco:"tiron_espalda_biceps",
        lugar:"casa",
        tips:"Codos pegados al cuerpo, aprieta esc√°pulas atr√°s.",
        yt:"remo con mancuerna espalda alta tecnica"
    },
    {
        nombre:"Jal√≥n al pecho / polea",
        musculo:"Espalda dorsal",
        tipo:"espalda",
        foco:"dorsal_anchura",
        lugar:"gimnasio",
        tips:"Pecho arriba, tira con espalda no solo con brazos.",
        yt:"jalon al pecho polea tecnica"
    },
    {
        nombre:"Plancha isom√©trica",
        musculo:"Core / Abdomen profundo",
        tipo:"core",
        foco:"core_estabilidad",
        lugar:"casa",
        tips:"Cadera ni muy alta ni muy baja. Mira al piso.",
        yt:"plancha abdominal tecnica"
    },
    {
        nombre:"Crunch / Abdominales cortos",
        musculo:"Abdomen superior",
        tipo:"core",
        foco:"core_superior",
        lugar:"casa",
        tips:"Sube controlado, no tires del cuello.",
        yt:"crunch abdominal correcto"
    },
    {
        nombre:"Elevaci√≥n lateral mancuernas",
        musculo:"Hombro lateral / Deltoides medio",
        tipo:"hombro",
        foco:"deltoide_medio",
        lugar:"gimnasio",
        tips:"Codos ligeramente flexionados, sube hasta nivel hombro.",
        yt:"elevaciones laterales deltoides medio tecnica"
    },
    {
        nombre:"Fondos en banco / silla",
        musculo:"Tr√≠ceps",
        tipo:"brazo",
        foco:"triceps_fondos",
        lugar:"casa",
        tips:"Codos atr√°s, baja lento. M√°s dif√≠cil: pies m√°s lejos.",
        yt:"fondos en banco triceps tecnica"
    },
    {
        nombre:"Jumping jacks",
        musculo:"Cardio general",
        tipo:"cardio",
        foco:"cardio_basico_total",
        lugar:"casa",
        tips:"Mant√©n ritmo constante, aterriza suave.",
        yt:"jumping jacks ejercicio cardio"
    },
    {
        nombre:"Bicicleta est√°tica / el√≠ptica",
        musculo:"Cardio bajo impacto",
        tipo:"cardio",
        foco:"cardio_moderado",
        lugar:"gimnasio",
        tips:"Respiraci√≥n constante, no bloquees rodillas.",
        yt:"bicicleta estatica cardio bajo impacto"
    }
];

/* ==============================
   LOGICA SERIES / PROGRESION
================================= */
function getSetsReps(nivel, objetivo, tipoEjercicio, fatiga, duracion, weekLevel){
    // base seg√∫n nivel
    let series = 3;
    let reps = "12-15 repeticiones";
    let hold = "30-45 seg";

    if(nivel==="bajo"){
        series = 2;
        reps = "10-12 repeticiones";
        hold = "20-30 seg";
    } else if(nivel==="alto"){
        series = 4;
        reps = "15-20 repeticiones";
        hold = "45-60 seg";
    }

    // progresi√≥n semanal (weekLevel sube con el tiempo)
    // cada semana sumamos +1 serie en fuerza, pero respetando fatiga
    if(weekLevel > 1){
        series += (weekLevel-1); // semana 2 => +1, semana 3 => +2 ...
    }

    // objetivo m√∫sculo -> m√°s volumen fuerza
    if(objetivo==="musculo" && ["piernas","pecho","espalda","hombro","brazo"].includes(tipoEjercicio)){
        series += 1;
    }

    // objetivo bajar grasa/resistencia -> cardio m√°s largo
    if((objetivo==="bajar grasa"||objetivo==="resistencia") && tipoEjercicio==="cardio"){
        hold = "40-60 seg ritmo constante";
    }

    // ajuste por fatiga amarilla o roja: bajamos una serie
    if(fatiga==="amarillo"){
        series = Math.max(series-1,1);
    } else if(fatiga==="rojo"){
        series = Math.max(series-2,1);
    }

    // ajuste por duraci√≥n (20 min = menos volumen total)
    if(duracion==="20 min"){
        series = Math.max(series-1,1);
    } else if(duracion==="+1 hora"){
        series += 1;
    }

    if(tipoEjercicio==="core"){
        return { series, reps: hold };
    }
    return { series, reps };
}

/* ==============================
   RENDER VISUAL DE EJERCICIO
   con checkbox ‚úÖ y link a t√©cnica
   + advertencias por lesi√≥n
================================= */
function buildSafetyNoteForExercise(ej, lesionesText){
    const low = (lesionesText||"").toLowerCase();
    let notes = [];
    if(low.includes("rodilla") && ej.tipo==="piernas"){
        notes.push("‚ö† Rodilla: no bajes m√°s de lo c√≥modo, sin dolor agudo.");
    }
    if(low.includes("lumbar") && (ej.tipo==="piernas" || ej.tipo==="core" || ej.tipo==="espalda")){
        notes.push("‚ö† Zona lumbar: mant√©n espalda neutra y evita rebotes r√°pidos.");
    }
    return notes.join(" ");
}

function renderExerciseItem(ejercicio, cfg, lesionesText){
    const safety = buildSafetyNoteForExercise(ejercicio, lesionesText);
    const ytQuery = encodeURIComponent(ejercicio.yt || ejercicio.nombre + " tecnica ejercicio");
    const youtubeLink = "https://www.youtube.com/results?search_query="+ytQuery;

    // cada ejercicio tendr√° su propio checkbox; usaremos un listener luego
    return `
    <div class="exercise-item">
        <input type="checkbox" class="exercise-done-checkbox" />
        <div class="exercise-img">
            <!-- imagen de referencia -->
            <img src="https://images.pexels.com/photos/4761780/pexels-photo-4761780.jpeg?auto=compress&cs=tinysrgb&h=200&w=200"
                 alt="${ejercicio.nombre}" />
        </div>
        <div class="exercise-info">
            <div class="exercise-name">
                <span>${ejercicio.nombre}</span>
                <small style="font-size:.7rem;font-weight:500;color:var(--subtext);">${ejercicio.musculo}</small>
            </div>
            <div class="exercise-sets"><strong>${cfg.series} series</strong> ¬∑ ${cfg.reps}</div>
            <div class="exercise-extra">${ejercicio.tips}${safety?(" "+safety):""}</div>
            <div class="exercise-link"><a href="${youtubeLink}" target="_blank">Ver t√©cnica segura ‚Üó</a></div>
        </div>
    </div>`;
}

function renderBlock(tituloIcon, musculoLabel, ejerciciosHTML){
    return `
    <div class="routine-block">
        <h3>
            <span>${tituloIcon}</span>
            <span class="routine-muscle">${musculoLabel}</span>
        </h3>
        <div class="exercise-list">
            ${ejerciciosHTML}
        </div>
    </div>`;
}

/* ==============================
   PLANTILLAS DE D√çAS
   - Adaptamos qu√© d√≠as existen seg√∫n "dias/semana"
================================= */
function getDayTypesForUser(diasSemana){
    const d = parseInt(diasSemana,10);
    if(d<=2){ // gente que entrena poco: fullbody empuje/tir√≥n/ piernas mezclado
        return ["A","B"]; // rotan A/B/A/B...
    }
    if(d<=4){
        return ["A","B","C"]; // cl√°sico
    }
    // 5+ d√≠as: agregamos d√≠a D (movilidad/recuperaci√≥n activa/core)
    return ["A","B","C","D"];
}

function pickExercisesForDay(dayType, data, ejerciciosFiltrados){
    // helper que devuelve lista por foco
    function pickByFoco(focos, maxCant){
        const arr = ejerciciosFiltrados.filter(e=>focos.includes(e.foco));
        return arr.slice(0,maxCant);
    }

    // m√°s liviano si fatiga rojo -> priorizar core / movilidad
    const fatigaRoja = data.fatiga==="rojo";

    if(dayType==="A"){
        return {
            baseTitle:"D√≠a A ¬∑ Pierna fuerte + Core ü¶µ",
            blocks:[
                {
                    titulo:"Piernas & Gl√∫teos ü¶µ",
                    label:"Fuerza inferior",
                    focos: fatigaRoja ? ["piernas_estabilidad"] : ["piernas_gluteos","posterior_cadena"],
                    max:2
                },
                {
                    titulo:"Core Estable üß±",
                    label:"Abdomen / Zona lumbar",
                    focos:["core_estabilidad","core_superior"],
                    max:2
                },
                {
                    titulo:"Activaci√≥n Cardio ü´Ä",
                    label:"Ox√≠geno / Calentamiento",
                    focos:["cardio_basico_total","cardio_moderado"],
                    max:1
                }
            ]
        };
    }

    if(dayType==="B"){
        return {
            baseTitle:"D√≠a B ¬∑ Empuje (Pecho / Tr√≠ceps / Hombro) üí™",
            blocks:[
                {
                    titulo:"Pecho & Tr√≠ceps üí™",
                    label:"Empuje frontal",
                    focos:["empuje_pecho_triceps","hipertrofia_pecho","triceps_fondos"],
                    max:2
                },
                {
                    titulo:"Hombro / Deltoide üßä",
                    label:"Estabilidad escapular",
                    focos:["deltoide_medio"],
                    max:1
                },
                {
                    titulo:"Core R√°pido üß±",
                    label:"Postura / Centro",
                    focos:["core_superior","core_estabilidad"],
                    max:1
                }
            ]
        };
    }

    if(dayType==="C"){
        return {
            baseTitle:"D√≠a C ¬∑ Tir√≥n (Espalda) + Pierna Estabilidad + Cardio üêç",
            blocks:[
                {
                    titulo:"Espalda & B√≠ceps üêç",
                    label:"Tir√≥n / Postura",
                    focos:["tiron_espalda_biceps","dorsal_anchura"],
                    max:2
                },
                {
                    titulo:"Pierna Control ü¶µ",
                    label:"Equilibrio / Estabilidad",
                    focos:["piernas_estabilidad","piernas_gluteos"],
                    max:1
                },
                {
                    titulo:"Cardio / Resistencia ü´Ä",
                    label:"Quema grasa / Aguante",
                    focos:["cardio_basico_total","cardio_moderado"],
                    max:1
                }
            ]
        };
    }

    // D = recuperaci√≥n activa / movilidad / core suave
    return {
        baseTitle:"D√≠a D ¬∑ Movilidad + Core + Bajo Impacto üåø",
        blocks:[
            {
                titulo:"Movilidad Controlada üåø",
                label:"Articulaciones sanas",
                focos:["piernas_estabilidad","core_estabilidad"],
                max:2
            },
            {
                titulo:"Core Suave üß±",
                label:"Protecci√≥n lumbar",
                focos:["core_estabilidad","core_superior"],
                max:2
            },
            {
                titulo:"Cardio Bajo Impacto ü´Ä",
                label:"Flujo / Recuperaci√≥n",
                focos:["cardio_moderado"],
                max:1
            }
        ]
    };
}

/* ==============================
   FLAVOR DEL DIA SEG√öN OBJETIVO
================================= */
function getCycleFlavor(baseTitle, data){
    if(data.objetivo==="musculo" || data.preferencia==="fuerza"){
        return baseTitle + " ¬∑ Enfoque Fuerza / Hipertrofia";
    }
    if(data.objetivo==="bajar grasa" || data.preferencia==="hiit" || data.preferencia==="cardio"){
        return baseTitle + " ¬∑ Enfoque Cardio / Quema cal√≥rica";
    }
    if(data.preferencia==="movilidad" || data.intensidad==="suave"){
        return baseTitle + " ¬∑ Ritmo controlado / Cuidado articular";
    }
    return baseTitle + " ¬∑ Balance General";
}

/* ==============================
   WARNINGS Y CALENTAMIENTO
================================= */
function buildWarmupText(lesiones){
    const low = (lesiones||"").toLowerCase();
    let tips = [];
    if(low.includes("rodilla")){
        tips.push("Calentamiento rodilla: flexiones de rodilla suaves apoyado/a en pared, tobillo activo, sentadilla parcial lenta x 10.");
    }
    if(low.includes("lumbar")){
        tips.push("Calentamiento lumbar: cat-cow suave en el suelo, inclinaciones p√©lvicas controladas, nada brusco.");
    }
    if(!tips.length){
        tips.push("Calentamiento general: movilidad de cuello, hombros, cadera y rodillas por ~5 minutos con movimientos lentos y sin dolor.");
    }
    return tips.join(" ");
}

function shouldShowOveruseWarning(historyArr){
    // Miramos el historial reciente (√∫ltimas 3 entradas)
    const recent = historyArr.slice(-3);
    const countPiernaPesada = recent.filter(h=>h.includes("D√≠a A") || h.includes("Pierna fuerte")).length;
    return countPiernaPesada >= 2;
}

/* ==============================
   RENDER RUTINA COMPLETA
================================= */
function generarRutina(data){
    // Guardar perfil en localStorage
    saveProfile(data);

    // cargamos index y weekLevel
    let routineIndex = loadRoutineIndex();
    let weekLevel = loadWeekLevel();

    // d√≠a que toca seg√∫n d√≠as/semana
    const dayTypes = getDayTypesForUser(data.dias);
    const currentDayType = dayTypes[routineIndex % dayTypes.length];

    // filtramos ejercicios por lugar
    const lugarPreferido = data.lugar === "mixto" ? "casa" : data.lugar;
    const ejerciciosFiltrados = EXERCISES.filter(ex => ex.lugar === lugarPreferido || data.lugar==="mixto");

    // obtenemos layout del d√≠a actual
    const planDelDia = pickExercisesForDay(currentDayType, data, ejerciciosFiltrados);

    // construimos bloques (ajustamos cantidad por duraci√≥n)
    const longSession = data.duracion === "+1 hora";
    const shortSession = data.duracion === "20 min";

    let blocksHTML = "";
    planDelDia.blocks.forEach(bloque => {
        let listaEj = [];
        // calcular m√°ximo din√°mico seg√∫n duraci√≥n
        let maxCant = bloque.max;
        if(shortSession){ maxCant = Math.max(1, maxCant-1); }
        if(longSession){ maxCant = maxCant+1; }

        // recolectar ejercicios por foco
        const focos = bloque.focos;
        const pool = ejerciciosFiltrados.filter(e => focos.includes(e.foco));
        // tomamos primeros distintos hasta maxCant
        const chosen = pool.slice(0,maxCant);

        let inner = "";
        chosen.forEach(ex=>{
            const cfg = getSetsReps(
                data.nivel,
                data.objetivo,
                ex.tipo,
                data.fatiga,
                data.duracion,
                weekLevel
            );
            inner += renderExerciseItem(ex,cfg,data.lesiones);
        });

        blocksHTML += renderBlock(bloque.titulo, bloque.label, inner);
    });

    // info meta arriba
    const metaParts = [];
    metaParts.push(`${data.dias} d√≠as/semana`);
    metaParts.push(`${data.duracion} por sesi√≥n`);
    metaParts.push(`Objetivo: ${data.objetivo}`);
    metaParts.push(`Nivel: ${data.nivel}`);
    const metaString = metaParts.join(" ‚Ä¢ ");

    // flavor del t√≠tulo
    const flavoredTitle = getCycleFlavor(planDelDia.baseTitle, data);

    // fatiga label
    let fatigaText = "üíö Fresco";
    let fatigaClass = "fatigue-green";
    if(data.fatiga==="amarillo"){ fatigaText = "üü° Cansado"; fatigaClass="fatigue-yellow"; }
    if(data.fatiga==="rojo"){ fatigaText = "üî¥ Muy cargado"; fatigaClass="fatigue-red"; }

    const fatigaView = document.getElementById("fatigaView");
    fatigaView.textContent = "Estado: " + fatigaText;
    fatigaView.className = "fatigue-label " + fatigaClass;

    // aplicar en DOM
    document.getElementById("chipLugar").textContent = data.lugar.toUpperCase();
    document.getElementById("routineMeta").textContent = metaString;
    document.getElementById("routineBlocks").innerHTML = blocksHTML;
    document.getElementById("cycleLabel").textContent = flavoredTitle;

    // mostrar calentamiento personalizado
    const warmupMsg = buildWarmupText(data.lesiones);
    const warmupBox = document.getElementById("warmupBox");
    warmupBox.textContent = "Calentamiento recomendado: " + warmupMsg;
    warmupBox.style.display = "block";

    // advertencias lesiones
    const showAlerta = (
        (data.lesiones && data.lesiones.trim().toLowerCase() !== "ninguna") ||
        (data.condicion && data.condicion.trim().toLowerCase() !== "ninguna")
    );
    document.getElementById("alertaLesion").style.display = showAlerta ? "block" : "none";

    // historial y sobrecarga
    const nowStr = new Date().toLocaleString();
    const histEntry = `${nowStr} ¬∑ ${flavoredTitle}`;
    const histArr = loadHistory();
    histArr.push(histEntry);
    saveHistory(histArr);
    renderHistoryList(histArr);

    const overuse = shouldShowOveruseWarning(histArr);
    document.getElementById("sobrecargaWarning").style.display = overuse ? "block" : "none";

    // mostrar secciones
    document.getElementById("routineSection").style.display = "block";
    document.getElementById("historySection").style.display = "block";

    // scroll suave a rutina
    document.getElementById("routineSection").scrollIntoView({behavior:"smooth"});

    // avanzar el √≠ndice para pr√≥xima vez
    routineIndex = (routineIndex + 1) % dayTypes.length;
    saveRoutineIndex(routineIndex);

    // progresi√≥n semanal b√°sica:
    // cada 5 rutinas generadas, subimos weekLevel (simula pasar de semana)
    if(histArr.length % 5 === 0){
        saveWeekLevel( loadWeekLevel() + 1 );
    }

    // ahora que est√°n en DOM los ejercicios, conectamos los checkboxes
    attachCheckboxHandlers();
}

/* ==============================
   CHECKBOX "HECHO ‚úÖ"
================================= */
function attachCheckboxHandlers(){
    const items = document.querySelectorAll(".exercise-item");
    items.forEach(item=>{
        const cb = item.querySelector(".exercise-done-checkbox");
        cb.addEventListener("change",()=>{
            if(cb.checked){
                item.classList.add("done");
            }else{
                item.classList.remove("done");
            }
        });
    });
}

/* ==============================
   HISTORIAL
================================= */
function renderHistoryList(histArr){
    const wrap = document.getElementById("historyList");
    wrap.innerHTML = "";
    // mostrar del m√°s reciente al m√°s antiguo
    const reversed = [...histArr].reverse();
    reversed.forEach(h=>{
        const div = document.createElement("div");
        div.className="history-item";
        div.textContent = h;
        wrap.appendChild(div);
    });
}

/* ==============================
   THEME TOGGLE
================================= */
const themeToggleBtn = document.getElementById("themeToggle");
function loadTheme(){
    const saved = localStorage.getItem("rutinaThemeV1") || "light";
    document.documentElement.setAttribute("data-theme", saved);
    themeToggleBtn.textContent = saved==="light"?"üåô Oscuro":"‚òÄ Claro";
}
function toggleTheme(){
    const current = document.documentElement.getAttribute("data-theme") || "light";
    const next = current==="light"?"dark":"light";
    document.documentElement.setAttribute("data-theme", next);
    localStorage.setItem("rutinaThemeV1", next);
    themeToggleBtn.textContent = next==="light"?"üåô Oscuro":"‚òÄ Claro";
}
themeToggleBtn.addEventListener("click", toggleTheme);

/* ==============================
   PRINT / PDF
================================= */
document.getElementById("printBtn").addEventListener("click",()=>{
    window.print();
});

/* ==============================
   NAVBAR BOTONES
================================= */
document.getElementById("navShowRoutine").addEventListener("click",()=>{
    document.getElementById("routineSection").scrollIntoView({behavior:"smooth"});
});
document.getElementById("navGenerateNext").addEventListener("click",()=>{
    // Generar una nueva rutina con el perfil guardado actual sin tener que tocar el form
    const perfilGuardado = getDataFromUIorStorage();
    if(perfilGuardado){
        generarRutina(perfilGuardado);
    }else{
        alert("Completa tu perfil primero para generar rutina.");
    }
});
document.getElementById("navShowProfile").addEventListener("click",()=>{
    document.getElementById("perfilCard").scrollIntoView({behavior:"smooth"});
});
document.getElementById("navShowHistory").addEventListener("click",()=>{
    document.getElementById("historySection").scrollIntoView({behavior:"smooth"});
});

/* ==============================
   TOMAR DATOS DEL FORM / STORAGE
================================= */
function getDataFromUI(){
    return {
        genero: document.getElementById("genero").value,
        edad: document.getElementById("edad").value,
        peso: document.getElementById("peso").value,
        altura: document.getElementById("altura").value,
        objetivo: document.getElementById("objetivo").value,
        lesiones: document.getElementById("lesiones").value,
        condicion: document.getElementById("condicion").value,
        tiempoSinEntrenar: document.getElementById("tiempoSinEntrenar").value,
        nivel: document.getElementById("nivel").value,
        dias: document.getElementById("dias").value,
        duracion: document.getElementById("duracion").value,
        horario: document.getElementById("horario").value,
        lugar: document.getElementById("lugar").value,
        espacio: document.getElementById("espacio").value,
        equipo: document.getElementById("equipo").value,
        preferencia: document.getElementById("preferencia").value,
        experiencia: document.getElementById("experiencia").value,
        motivacion: document.getElementById("motivacion").value,
        intensidad: document.getElementById("intensidad").value,
        acompanamiento: document.getElementById("acompanamiento").value,
        fatiga: document.getElementById("fatiga").value,
        fuerzaBase: document.getElementById("fuerzaBase").value,
        plazo: document.getElementById("plazo").value,
        seguimiento: document.getElementById("seguimiento").value,
        motivacionEspecial: document.getElementById("motivacionEspecial").value
    };
}

// mezcla: si falta algo en UI, intento usar perfil ya guardado
function getDataFromUIorStorage(){
    const ui = getDataFromUI();
    const saved = loadProfile() || {};
    return {...saved, ...ui};
}

/* ==============================
   AUTORELLENO AL CARGAR
================================= */
function fillUIFromProfile(p){
    if(!p) return;
    const setVal=(id,v)=>{ if(v!==undefined && v!==null && document.getElementById(id)){document.getElementById(id).value=v;} };
    setVal("genero",p.genero);
    setVal("edad",p.edad);
    setVal("peso",p.peso);
    setVal("altura",p.altura);
    setVal("objetivo",p.objetivo);
    setVal("lesiones",p.lesiones);
    setVal("condicion",p.condicion);
    setVal("tiempoSinEntrenar",p.tiempoSinEntrenar);
    setVal("nivel",p.nivel);
    setVal("dias",p.dias);
    setVal("duracion",p.duracion);
    setVal("horario",p.horario);
    setVal("lugar",p.lugar);
    setVal("espacio",p.espacio);
    setVal("equipo",p.equipo);
    setVal("preferencia",p.preferencia);
    setVal("experiencia",p.experiencia);
    setVal("motivacion",p.motivacion);
    setVal("intensidad",p.intensidad);
    setVal("acompanamiento",p.acompanamiento);
    setVal("fatiga",p.fatiga);
    setVal("fuerzaBase",p.fuerzaBase);
    setVal("plazo",p.plazo);
    setVal("seguimiento",p.seguimiento);
    setVal("motivacionEspecial",p.motivacionEspecial);
}

/* ==============================
   VALIDACI√ìN M√çNIMA
================================= */
function validateData(data){
    if(!data.genero || !data.edad || !data.peso || !data.altura ||
       !data.objetivo || !data.nivel || !data.dias || !data.duracion ||
       !data.horario || !data.lugar){
        return false;
    }
    return true;
}

/* ==============================
   EVENTOS PRINCIPALES
================================= */
document.getElementById("generarBtn").addEventListener("click",()=>{
    const data = getDataFromUIorStorage();

    if(!validateData(data)){
        alert("Por favor completa los campos obligatorios marcados (listas principales).");
        return;
    }

    generarRutina(data);
});

/* iniciar */
(function init(){
    loadTheme();

    // si hay perfil guardado lo cargamos al form
    const savedProfile = loadProfile();
    if(savedProfile){
        fillUIFromProfile(savedProfile);
    }

    // mostrar historial guardado si existe
    const histArr = loadHistory();
    if(histArr && histArr.length){
        document.getElementById("historySection").style.display = "block";
        renderHistoryList(histArr);
    }
})();
</script>
</body>
</html>
